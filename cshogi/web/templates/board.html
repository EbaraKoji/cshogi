<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="{{url_for('static', filename='board.js')}}"></script>
    <script>
        let moves = [{% for move in moves %}{move:{{move['move']}},eval:{{move['eval']}},ahead:"{{move['ahead']}}"},{% endfor %}];
        let board = new Board();

        let current = 0;
        function selectMoveNumber(number) {
            rows = $("#moves tr");
            if (rows.length > 0) {
                if (number < 0 || number > rows.length) return;
                if (current > 0)
                    rows.eq(current - 1).removeClass("table-active");
                if (number > 0)
                    rows.eq(number - 1).addClass("table-active");

                let currentTop = $("#moves").scrollTop() / rows.eq(0).height();
                if (number - 1 < currentTop || number - 1 > currentTop + 8)
                    $("#moves").scrollTop(rows.eq(0).height() * (number - 1));

                current = number;
                $("#move-number").val(current);
                updateBoard(current);
            }
        }

        function updateBoard(number) {
            board.reset();
            let len = number;
            if (len == moves.length && moves[len - 1] == 0)
                len--;
            for (let i = 0; i < len; i++)
                board.move(moves[i]['move']);
            $("#board").html(board.to_svg(1.5));
            comments = len % 2 == 0 ? [$("#white-comment"), $("#black-comment")] : [$("#black-comment"), $("#white-comment")];

            let eval = '';
            let ahead = '';
            if (len > 0) {
                eval = moves[len - 1]['eval'];
                if (eval == null) eval = '';
                ahead = moves[len - 1]['ahead'];
            }
            comments[0].html("<td>" + eval + "</td><td>" + ahead + "</td>");

            eval = '';
            ahead = '';
            if (len - 1 > 0) {
                eval = moves[len - 2]['eval'];
                if (eval == null) eval = '';
                ahead = moves[len - 2]['ahead'];
            }
            comments[1].html("<td>" + eval + "</td><td>" + ahead + "</td>");
        }

        function drawEvalGraph() {
            let canvas = $("#eval-graph");
            let width = 25 + 256 * 2;
            if (moves.length > 256) {
                width = 25 + moves.length * 2;
                canvas.attr("width", width);
            }
            let ctx = canvas[0].getContext("2d");

            ctx.fillStyle = "#D0D0FF";
            ctx.fillRect(0, 0, width, 160);

            ctx.beginPath();
            ctx.strokeStyle = "#080808";
            ctx.moveTo(0, 80);
            ctx.lineTo(600, 80);
            ctx.moveTo(25, 0);
            ctx.lineTo(25, 160);
            ctx.stroke();

            ctx.fillStyle = "#080808";
            for (let i = 2000; i >= -2000; i -= 1000) {
                if (i == 0) continue;
                const y = 80 - i * 3 / 100;

                ctx.beginPath();
                ctx.strokeStyle = "gray";
                ctx.setLineDash([1, 4]);
                ctx.moveTo(28, y);
                ctx.lineTo(width, y);
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = "#080808";
                ctx.setLineDash([]);
                ctx.moveTo(22, y);
                ctx.lineTo(27, y);
                ctx.stroke();

                ctx.font = "8px serif";
                ctx.fillText(i, 0, y + 3);
            }

            for (let i = 50; i < Math.max(256, moves.length); i += 50) {
                ctx.beginPath();
                ctx.strokeStyle = "gray";
                ctx.setLineDash([1, 6]);
                ctx.moveTo(25 + i * 2, 0);
                ctx.lineTo(25 + i * 2, 160);
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = "#080808";
                ctx.setLineDash([]);
                ctx.moveTo(25 + i * 2, 78);
                ctx.lineTo(25 + i * 2, 82);
                ctx.stroke();

                ctx.fillText(i, 20 + i * 2, 89);
            }

            ctx.lineWidth = 2.5;
            for (let c = 1; c <= 2; c++) {
                ctx.strokeStyle = c == 1 ? "black" : "white";
                ctx.beginPath();
                let needMove = true;
                for (let i = c; i < moves.length; i += 2) {
                    let eval = moves[i - 1]['eval'];
                    if (eval != null) {
                        const y = Math.min(160, Math.max(0, 80 - eval * 80 / 30000));
                        if (needMove) {
                            ctx.moveTo(25 + i * 2, y);
                            needMove = false;
                        } else
                            ctx.lineTo(25 + i * 2, y);
                    } else {
                        needMove = true;
                    }
                }
                ctx.stroke();
            }
        }

        $(function() {
            updateBoard(0);
            drawEvalGraph();

            $("#moves tr").click(function() {
                selectMoveNumber($(this).index() + 1);
            });
            $("#btn-first").click(function() {
                selectMoveNumber(0);
            });
            $("#btn-back").click(function() {
                selectMoveNumber(current - 1);
            });
            $("#btn-next").click(function() {
                selectMoveNumber(current + 1);
            });
            $("#btn-last").click(function() {
                selectMoveNumber($("#moves tr").length);
            });
            $("#move-number").change(function() {
                selectMoveNumber(Number($(this).val()));
            });
        });
    </script>
    <style type="text/css">
        svg {
            -ms-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row m-1">
            <div class="col">
                ▲{{names[0]}} △{{names[1]}}
            </div>
        </div>
        <div class="row">
            <div class="col-auto">
                <div id="board"></div>
            </div>
            <div class="col">
                <div id="moves" style="height: 300px; width: 14.5em; overflow-y: scroll;">
                    <table class="table table-borderless table-sm table-hover" style="width: 13em;">
                        {% for move in moves %}
                        <tr>
                            <td style="width:3em; text-align: right;">{{move['number']}}</td>
                            <td nowrap>{{move['kif_move']}}</td>
                            <td nowrap style="text-align: right;">{{move['time']}}秒</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <button type="button" id="btn-first" class="btn btn-light">最初へ</button>
                <button type="button" id="btn-back" class="btn btn-light">&lt;</button>
                <input type="text" id="move-number" style="width: 2em;" value="0">手目
                <button type="button" id="btn-next" class="btn btn-light">&gt;</button>
                <button type="button" id="btn-last" class="btn btn-light">最後へ</button>
            </div>
        </div>
        <div class="row mt-1">
            <div class="col border" style="height: 60px; overflow-y: scroll;">
                <table class="table table-sm small table-borderless" style="height: 40px;">
                    <thead>
                        <tr>
                            <td style="width: 6em;">評価値</td>
                            <td>読み筋</td>
                        </tr>
                    </thead>
                    <tbody><tr id="black-comment"></tr></tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col border" style="height: 60px; overflow-y:scroll;">
                <table class="table table-sm small table-borderless" style="height: 40px;">
                    <thead>
                        <tr>
                            <td style="width: 6em;">評価値</td>
                            <td>読み筋</td>
                        </tr>
                    </thead>
                    <tbody><tr id="white-comment"></tr></tbody>
                </table>
            </div>
        </div>
        <div class="row mt-1">
            <div class="col">
                <canvas id="eval-graph" width="537" height="160"></canvas>
            </div>
        </div>
    </div>
</body>
</html>
